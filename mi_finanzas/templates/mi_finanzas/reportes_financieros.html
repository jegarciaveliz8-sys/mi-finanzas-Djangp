{% extends "mi_finanzas/base.html" %} 

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">{{ titulo }}</h2>

    {% if not gastos_por_categoria %}
        <div class="alert alert-info">
            No hay suficientes datos de transacciones de GASTO para generar reportes en este período.
        </div>
    {% endif %}

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white">
            Resumen de Flujo de Caja Mensual
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h5 class="text-success">Ingresos</h5>
                    <h3>${{ resumen_mensual.ingresos|floatformat:2 }}</h3>
                </div>
                <div class="col-md-4">
                    <h5 class="text-danger">Gastos</h5>
                    <h3>${{ resumen_mensual.gastos|floatformat:2 }}</h3>
                </div>
                <div class="col-md-4">
                    <h5 class="text-primary">Flujo Neto</h5>
                    <h3 class="{% if resumen_mensual.neto >= 0 %}text-success{% else %}text-danger{% endif %}">${{ resumen_mensual.neto|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    Distribución de Gastos por Categoría
                </div>
                <div class="card-body">
                    <canvas id="gastosChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    Top Categorías de Gasto
                </div>
                <div class="card-body">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Categoría</th>
                                <th>Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gasto in gastos_por_categoria %}
                            <tr>
                                <td>{{ gasto.categoria__nombre|default:"Sin Categoría" }}</td>
                                <td>${{ gasto.total|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Preparar datos para el gráfico
    // CORRECCIÓN CLAVE: Usamos la variable JSON serializada que viene de views.py
    const gastosData = JSON.parse('{{ gastos_por_categoria_json|safe|escapejs }}');
    
    // Si no hay datos, salimos de la función para no intentar crear un gráfico vacío.
    if (gastosData.length === 0) {
        return; 
    }
    
    const labels = gastosData.map(item => item.categoria__nombre || 'Sin Categoría');
    const data = gastosData.map(item => parseFloat(item.total));
    
    // Colores aleatorios para el gráfico
    const backgroundColors = data.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);
    const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

    // 2. Configuración del gráfico
    const ctx = document.getElementById('gastosChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut', // Gráfico circular de anillo
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endblock extra_js %}

