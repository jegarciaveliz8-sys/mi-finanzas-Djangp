from django.shortcuts import render
from django.db.models import Sum
from django.db.models.functions import Coalesce
from decimal import Decimal
from django.contrib.auth.decorators import login_required
from datetime import date
import calendar
import json # Necesario para enviar datos al gráfico de gastos

from .models import Cuenta, Transaccion, Presupuesto
from .utils import obtener_color_presupuesto

@login_required
def resumen_financiero(request):
    usuario = request.user
    hoy = date.today()
    mes_actual_num = hoy.month
    anio_actual = hoy.year
    
    # Obtener el nombre del mes actual en español (asumiendo que Django ya maneja el locale)
    mes_actual = calendar.month_name[mes_actual_num] # El nombre del mes en inglés, si necesitas español puro usa un diccionario o el módulo locale

    # 1. SALDOS Y MÉTRICAS GENERALES
    
    # Sumar el balance de todas las cuentas
    saldo_total_neto = Cuenta.objects.filter(usuario=usuario).aggregate(
        total=Coalesce(Sum('balance'), Decimal(0.00))
    )['total']

    # Transacciones base del mes actual
    transacciones_mes_base = Transaccion.objects.filter(
        usuario=usuario, 
        fecha__year=anio_actual, 
        fecha__month=mes_actual_num
    )

    # Ingresos del mes
    ingresos_del_mes = transacciones_mes_base.filter(
        tipo='INGRESO'
    ).aggregate(
        total=Coalesce(Sum('monto'), Decimal(0.00))
    )['total']
    
    # Gastos del mes
    # NOTA: Los gastos y transferencias tienen un signo negativo en la base de datos, 
    # pero aquí los queremos como valor absoluto para mostrarlos.
    gastos_del_mes_bruto = transacciones_mes_base.filter(
        tipo='GASTO'
    ).aggregate(
        total=Coalesce(Sum('monto'), Decimal(0.00))
    )['total']
    
    gastos_del_mes = abs(gastos_del_mes_bruto) # Usamos valor absoluto para el display

    # 2. GASTOS POR CATEGORÍA (Para el Gráfico)
    gastos_por_categoria_queryset = transacciones_mes_base.filter(
        tipo='GASTO'
    ).values('categoria__nombre').annotate(
        total=Coalesce(Sum('monto'), Decimal(0.00))
    ).order_by('-total') # Ordenamos de mayor a menor gasto

    # Preparar datos para Chart.js
    chart_labels = [item['categoria__nombre'] for item in gastos_por_categoria_queryset]
    # Usamos el valor absoluto para las barras del gráfico
    chart_data_values = [abs(item['total']) for item in gastos_por_categoria_queryset]
    
    chart_data = json.dumps({
        'labels': chart_labels,
        'data': chart_data_values
    })

    # 3. PRESUPUESTOS (LA CORRECCIÓN ESTÁ AQUÍ)
    
    # 3.1 Obtener todos los presupuestos activos (el QuerySet original)
    presupuestos_activos = Presupuesto.objects.filter(
        usuario=usuario, 
        mes=mes_actual_num, 
        anio=anio_actual
    ).select_related('categoria') 
    
    resultados_presupuesto = []
    
    for presupuesto in presupuestos_activos:
        # 3.2 Calcular el gasto real para esta categoría
        gasto_real = transacciones_mes_base.filter(
            tipo='GASTO',
            categoria=presupuesto.categoria,
        ).aggregate(
            total=Coalesce(Sum('monto'), Decimal(0.00))
        )['total']

        # Usamos el valor absoluto del gasto
        gasto_real = abs(gasto_real)
        
        # 3.3 Calcular métricas
        limite = presupuesto.monto
        porcentaje = (gasto_real / limite) * 100 if limite > 0 else 0
        restante = limite - gasto_real
        
        # 3.4 Determinar el color de la barra (utils.py)
        color_barra = obtener_color_presupuesto(porcentaje)
        
        # 3.5 Crear el objeto de resultado
        resultados_presupuesto.append({
            'pk': presupuesto.pk,
            'categoria_nombre': presupuesto.categoria.nombre,
            'limite': limite,
            'gastado': gasto_real,
            'porcentaje': porcentaje,
            'restante': restante,
            'color_barra': color_barra
        })

    # 4. OTRAS MÉTRICAS
    cuentas = Cuenta.objects.filter(usuario=usuario).order_by('nombre')
    ultimas_transacciones = Transaccion.objects.filter(usuario=usuario).order_by('-fecha')[:5]

    # Lógica del Estado Financiero General (Simplificada)
    if saldo_total_neto >= 1000 and ingresos_del_mes > gastos_del_mes:
        estado_financiero = {'mensaje': '¡Excelente! Tu salud financiera es fuerte. Sigue así.', 'tipo': 'alert-success', 'icono': 'fa-check-circle'}
    elif saldo_total_neto >= 0:
        estado_financiero = {'mensaje': 'Estás en territorio positivo, pero considera aumentar tus ahorros.', 'tipo': 'alert-warning', 'icono': 'fa-exclamation-triangle'}
    else:
        estado_financiero = {'mensaje': 'Tu saldo es negativo. ¡Revisa tus gastos y ajusta tus presupuestos!', 'tipo': 'alert-danger', 'icono': 'fa-times-circle'}


    # 5. EL DICCIONARIO DE CONTEXTO CORREGIDO
    contexto = {
        'saldo_total_neto': saldo_total_neto,
        'ingresos_del_mes': ingresos_del_mes,
        'gastos_del_mes': gastos_del_mes,
        'mes_actual': mes_actual, 
        'anio_actual': anio_actual,
        
        'cuentas': cuentas,
        'gastos_por_categoria': gastos_por_categoria_queryset,
        'chart_data': chart_data,
        
        # ESTA ES LA CLAVE CORREGIDA QUE HACE QUE FUNCIONE
        'resultados_presupuesto': resultados_presupuesto, 
        
        'ultimas_transacciones': ultimas_transacciones,
        'estado_financiero': estado_financiero,
    }

    return render(request, 'mi_finanzas/resumen_financiero.html', contexto)

